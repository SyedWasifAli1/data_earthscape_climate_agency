{% extends 'dashboard.html' %}

{% block title %}{{ title }}{% endblock %}
{% block header %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white/80 backdrop-blur-md p-8 rounded-2xl shadow-2xl border border-gray-200">
  
  <!-- Form Header -->
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight flex items-center gap-2">
      üìÇ {{ title }}
    </h2>
    <a href="{% url 'dataset_list' %}" 
       class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg shadow transition">
      ‚Üê Back
    </a>
  </div>

  <form method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}

    <!-- Name -->
    <div>
      <label for="name" class="block text-sm font-semibold text-gray-700">Dataset Name</label>
      <input type="text" name="name" id="name" 
             value="{{ form.name.value|default_if_none:'' }}" 
             class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm 
                    px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
             placeholder="e.g. Global Climate Data 2025" required>
      {% if form.name.errors %}
      <p class="text-red-500 text-sm mt-1">{{ form.name.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- Source Type -->
    <div>
      <label for="source_type" class="block text-sm font-semibold text-gray-700">Source Type</label>
      <select name="source_type" id="source_type"
              class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm 
                     px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        {% for val, label in form.source_type.field.choices %}
          {% if val != "manual" %}
            <option value="{{ val }}" 
              {% if form.source_type.value == val %}selected{% elif not form.source_type.value and val == "file" %}selected{% endif %}>
              {{ label }}
            </option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <!-- File Format -->
    <div id="file_format_div">
      <label for="file_format" class="block text-sm font-semibold text-gray-700">File Format</label>
      <select name="file_format" id="file_format"
              class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm 
                     px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        {% for val, label in form.file_format.field.choices %}
        <option value="{{ val }}" {% if form.file_format.value == val %}selected{% endif %}>
          {{ label }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Upload File -->
    <div id="upload_file_div">
      <label for="upload_file" class="block text-sm font-semibold text-gray-700">Upload File</label>
      
      {% if dataset and dataset.upload_file %}
        <div class="mb-2 text-sm text-gray-600">
          Current File: 
          <a href="{{ dataset.upload_file }}" target="_blank" 
             class="text-blue-600 underline hover:text-blue-800">
            {{ dataset.upload_file|slice:"20:"|default:"View File" }}
          </a>
        </div>
      {% endif %}

      <input type="file" name="upload_file" id="upload_file" 
             class="mt-2 block w-full text-sm text-gray-600 border border-gray-300 
                    rounded-lg cursor-pointer bg-gray-50 shadow-sm
                    focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
    </div>

    <!-- Data Source URL -->
    <div id="data_source_url_div">
      <label for="data_source_url" class="block text-sm font-semibold text-gray-700">Data Source URL</label>
      <input type="url" name="data_source_url" id="data_source_url"
             value="{{ form.data_source_url.value|default_if_none:'' }}"
             placeholder="https://api.example.com/climate"
             class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm 
                    px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
    </div>

    <!-- Dates -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="date_start" class="block text-sm font-semibold text-gray-700">Start Date</label>
        <input type="date" name="date_start" id="date_start"
               value="{{ form.date_start.value|default_if_none:'' }}"
               class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm 
                      px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
      </div>
      <div>
        <label for="date_end" class="block text-sm font-semibold text-gray-700">End Date</label>
        <input type="date" name="date_end" id="date_end"
               value="{{ form.date_end.value|default_if_none:'' }}"
               class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm 
                      px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
      </div>
    </div>

    <!-- Realtime Checkbox -->
    <div class="flex items-center gap-3">
      <input type="checkbox" name="is_realtime" id="is_realtime"
             class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
             {% if form.is_realtime.value %}checked{% endif %}>
      <label for="is_realtime" class="text-sm font-semibold text-gray-700">Realtime Dataset</label>
    </div>

    <!-- Description -->
    <div>
      <label for="description" class="block text-sm font-semibold text-gray-700">Description</label>
      <textarea name="description" id="description" rows="4"
                placeholder="Write short description..."
                class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm 
                       px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">{{ form.description.value|default_if_none:'' }}</textarea>
    </div>

    <!-- Buttons -->
    <div class="flex space-x-4 pt-4">
      <button type="submit"
              class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-2.5 rounded-lg shadow-md 
                     hover:from-green-600 hover:to-emerald-700 transition font-semibold">
        üíæ Save Dataset
      </button>
      <a href="{% url 'dataset_list' %}" 
         class="bg-gradient-to-r from-gray-400 to-gray-500 text-white px-6 py-2.5 rounded-lg shadow-md 
                hover:from-gray-500 hover:to-gray-600 transition font-semibold">
        ‚úñ Cancel
      </a>
    </div>

  </form>
</div>

<script>
  function toggleFields() {
    const sourceType = document.getElementById("source_type").value;
    const fileFormatDiv = document.getElementById("file_format_div");
    const uploadFileDiv = document.getElementById("upload_file_div");
    const dataSourceUrlDiv = document.getElementById("data_source_url_div");

    if (sourceType === "api") {
      dataSourceUrlDiv.style.display = "block";
      fileFormatDiv.style.display = "none";
      uploadFileDiv.style.display = "none";
    } else {
      dataSourceUrlDiv.style.display = "none";
      fileFormatDiv.style.display = "block";
      uploadFileDiv.style.display = "block";
    }
  }

  document.getElementById("upload_file").addEventListener("change", function () {
    const selectedFormat = document.getElementById("file_format").value;
    const allowedExtensions = {
      csv: ".csv",
      xlsx: ".xlsx",
      json: ".json",
      txt: ".txt"
    };
    const file = this.files[0];
    if (file) {
      const ext = "." + file.name.split(".").pop();
      if (allowedExtensions[selectedFormat] !== ext) {
        alert("‚ùå Invalid file type! Please upload a " + allowedExtensions[selectedFormat] + " file.");
        this.value = "";
      }
    }
  });

  document.getElementById("source_type").addEventListener("change", toggleFields);
  toggleFields();
</script>
{% endblock %}
