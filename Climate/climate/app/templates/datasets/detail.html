{% extends 'dashboard.html' %}

{% block title %}Datasets{% endblock %}
{% block header %}Datasets{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 space-y-8">
  <!-- Title -->
  <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-2">
    📄 {{ dataset.name }}
  </h1>

  <!-- Dataset Info Card -->
  <div class="bg-white shadow-lg rounded-xl p-6 border border-gray-100">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">Dataset Information</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-600">

      {% if dataset.source_type %}
      <div>
        <p class="font-medium text-gray-800">Source Type</p>
        <p class="text-gray-500">{{ dataset.source_type }}</p>
      </div>
      {% endif %}

      {% if dataset.file_format %}
      <div>
        <p class="font-medium text-gray-800">Format</p>
        <p class="text-gray-500">{{ dataset.file_format }}</p>
      </div>
      {% endif %}

      {% if dataset.data_source_url %}
      <div class="md:col-span-2">
        <p class="font-medium text-gray-800">API URL</p>
        <div class="flex gap-3 items-center mt-2">
          <input type="text" id="city-input" placeholder="Enter City"
                 class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
          <button id="fetch-btn" 
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
            🌍 Fetch Weather
          </button>
        </div>
        <p class="text-blue-600 break-all mt-2">{{ dataset.data_source_url }}</p>
      </div>
      {% endif %}

      {% if dataset.date_start or dataset.date_end %}
      <div>
        <p class="font-medium text-gray-800">Date Range</p>
        <p class="text-gray-500">
          {% if dataset.date_start %} {{ dataset.date_start }} {% endif %}
          {% if dataset.date_end %} → {{ dataset.date_end }} {% endif %}
        </p>
      </div>
      {% endif %}

      <div>
        <p class="font-medium text-gray-800">Real-Time</p>
        <span class="px-3 py-1 text-sm rounded-full 
                     {% if dataset.is_realtime %} bg-green-100 text-green-700 
                     {% else %} bg-gray-200 text-gray-600 {% endif %}">
          {{ dataset.is_realtime|yesno:"✅ Yes,❌ No" }}
        </span>
      </div>

      {% if dataset.description %}
      <div class="md:col-span-2">
        <p class="font-medium text-gray-800">Description</p>
        <p class="text-gray-600 leading-relaxed">{{ dataset.description }}</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Weather Result Card -->
  <div id="weather-result" class="bg-white shadow-lg rounded-xl p-6 border border-gray-100 hidden">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">🌤 Weather Forecast</h2>
    <div id="weather-card" class="space-y-4"></div>
  </div>

  <!-- File Section -->
  {% if dataset.upload_file %}
  <div class="mt-8 bg-white shadow-lg rounded-xl p-6 border border-gray-100">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">📂 File Preview</h2>
    {% if dataset.file_format in "csv,xlsx,xls" %}
      <button onclick="openTable('{{ dataset.upload_file }}', '{{ dataset.file_format }}')" 
              class="bg-green-600 hover:bg-green-700 px-5 py-2 text-white font-medium rounded-lg shadow transition">
        📊 Open {{ dataset.file_format|upper }}
      </button>
      <div id="table-container" 
           class="mt-6 hidden overflow-x-auto border rounded-lg max-h-[500px]"></div>
    {% elif dataset.file_format == "pdf" %}
      <a href="{{ dataset.upload_file.url }}" target="_blank" 
         class="bg-red-600 hover:bg-red-700 px-5 py-2 text-white font-medium rounded-lg shadow transition">
        📕 Open PDF
      </a>
      <iframe src="{{ dataset.upload_file.url }}" 
              class="mt-6 w-full h-[600px] rounded-lg border"></iframe>
    {% else %}
      <a href="{{ dataset.upload_file.url }}" target="_blank" 
         class="bg-gray-700 hover:bg-gray-800 px-5 py-2 text-white font-medium rounded-lg shadow transition">
        📂 Open File
      </a>
    {% endif %}
  </div>
  {% endif %}

  <!-- Action Buttons -->
   
            {% if request.session.role == "admin" %}
  <div class="mt-8 flex flex-wrap gap-4">
    <a href="{% url 'dataset_update' dataset.id %}" 
       class="bg-yellow-500 hover:bg-yellow-600 px-5 py-2 text-white font-medium rounded-lg shadow transition">
      ✏ Edit
    </a>
    <form action="{% url 'dataset_delete' dataset.id %}" method="post" 
          onsubmit="return confirm('Are you sure you want to delete this dataset?');">
      {% csrf_token %}
      <button type="submit" 
              class="bg-red-500 hover:bg-red-600 px-5 py-2 text-white font-medium rounded-lg shadow transition">
        🗑 Delete
      </button>
    </form>
  </div>
           {% endif %}
</div>

<!-- Script for CSV/Excel Preview & Weather Fetch -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
async function openTable(fileUrl, format) {
  try {
    const res = await fetch(fileUrl);
    const data = await res.arrayBuffer();
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const html = XLSX.utils.sheet_to_html(sheet, { editable: false });
    const container = document.getElementById("table-container");
    container.innerHTML = html;
    container.classList.remove("hidden");
  } catch (err) {
    alert("⚠ Error loading file: " + err);
  }
}

document.getElementById("fetch-btn").addEventListener("click", async () => {
  const city = document.getElementById("city-input").value.trim();
  if (!city) return alert("❗ Please enter a city name.");

  const API_KEY = "api key";
  const apiUrl = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${city}&days=7&aqi=no&alerts=no`;

  try {
    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error("Error fetching weather data");
    const data = await res.json();

    const weatherResult = document.getElementById("weather-result");
    const weatherCard = document.getElementById("weather-card");

    weatherResult.classList.remove("hidden");

    weatherCard.innerHTML = `
      <div class="bg-gradient-to-r from-indigo-500 via-blue-500 to-cyan-400 p-6 md:p-8 rounded-3xl shadow-2xl text-white transition-transform duration-500 hover:scale-[1.02]">
        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
          <div class="space-y-3 text-center md:text-left">
            <h2 class="text-4xl font-extrabold flex items-center justify-center md:justify-start gap-2">
              📍 ${data.location.name}, ${data.location.country}
            </h2>
            <p class="text-2xl font-medium opacity-90">${data.current.condition.text}</p>
            <p class="text-6xl font-black drop-shadow-md animate-pulse">${data.current.temp_c}°C</p>
            <div class="flex justify-center md:justify-start gap-6 text-sm font-medium text-blue-100">
              <p>💧 Humidity: ${data.current.humidity}%</p>
              <p>💨 Wind: ${data.current.wind_kph} km/h</p>
            </div>
          </div>
          <div class="transition-transform duration-500 hover:scale-110">
            <img src="https:${data.current.condition.icon}" alt="weather icon" class="w-32 h-32 drop-shadow-xl">
          </div>
        </div>
      </div>

      <!-- 🌤 7-Day Forecast -->
      <div class="mt-8 bg-white/60 backdrop-blur-md border border-white/30 p-6 rounded-3xl shadow-xl transition-all duration-500">
        <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
          📅 7-Day Forecast
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
          ${data.forecast.forecastday.map((day, i) => `
            <div class="group bg-gradient-to-br from-blue-100 to-blue-200 p-5 rounded-2xl text-center shadow-md hover:shadow-lg hover:scale-[1.05] transform transition-all duration-300 hover:from-blue-200 hover:to-blue-300">
              <p class="font-semibold text-gray-700">${day.date}</p>
              <img src="https:${day.day.condition.icon}" alt="icon" class="mx-auto w-16 h-16 drop-shadow-md transition-all group-hover:scale-110">
              <p class="mt-2 text-sm text-gray-600">${day.day.condition.text}</p>
              <p class="font-bold text-gray-800 mt-2">🌡 Max: ${day.day.maxtemp_c}°C</p>
              <p class="text-sm text-gray-500">Min: ${day.day.mintemp_c}°C</p>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  } catch (error) {
    console.error(error);
    alert("⚠ Failed to fetch weather data. Check city name and API key.");
  }
});
</script>

{% endblock %}
